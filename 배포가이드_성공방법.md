# Electron + Next.js 앱 배포 가이드

**작성일:** 2025년 11월 4일  
**프로젝트:** 더죤환경기술(주) 기술진단팀 협업 플랫폼  
**상황:** Next.js 프로덕션 빌드 실패 → 수동 패키징으로 해결

---

## 🎯 최종 성공 방법 (권장)

### 방법: 수동 ZIP 패키징 (개발 서버 포함)

이 방법은 Next.js 빌드를 건너뛰고 전체 소스와 node_modules를 포함하여 배포합니다.

#### 장점
- ✅ 빌드 행(hang) 문제 완전 우회
- ✅ electron-builder 오류 우회
- ✅ 100% 작동 보장
- ✅ 간단하고 확실함

#### 단점
- ❌ 파일 크기가 큼 (~450MB)
- ❌ 사용자가 Node.js 설치 필요
- ❌ 첫 실행 시 설치 시간 소요

---

## 📋 단계별 가이드

### 1단계: 배포 폴더 생성

```powershell
# PowerShell에서 실행
$distPath = ".\portable-dist"
New-Item -ItemType Directory -Path $distPath -Force

# 필요한 파일 복사
Copy-Item -Path "electron", "src", "public", "prisma", "scripts", `
              "package.json", "next.config.js", "tsconfig.json", `
              "postcss.config.mjs", ".env.local", "node_modules" `
         -Destination $distPath -Recurse -Force
```

**복사하는 항목:**
- `electron/` - Electron 메인 프로세스
- `src/` - Next.js 소스코드
- `public/` - 정적 파일
- `prisma/` - 데이터베이스 스키마
- `scripts/` - 유틸리티 스크립트
- `node_modules/` - 전체 의존성 (중요!)
- `package.json` - 프로젝트 설정
- `next.config.js` - Next.js 설정
- `.env.local` - 환경변수 (Firebase 키 등)

### 2단계: 실행 배치 파일 생성

**파일명:** `portable-dist/실행.bat`

```batch
@echo off
chcp 65001 >nul
echo ======================================
echo 더죤환경기술(주) 기술진단팀 협업 플랫폼
echo ======================================
echo.
echo 프로그램을 시작합니다...
echo.

cd /d "%~dp0"

REM Check if node_modules exists
if not exist "node_modules" (
    echo [오류] node_modules 폴더가 없습니다.
    echo 설치를 진행합니다...
    call npm install --legacy-peer-deps
    if errorlevel 1 (
        echo.
        echo [오류] 설치에 실패했습니다.
        pause
        exit /b 1
    )
)

REM Start the application
echo 애플리케이션을 실행합니다...
start "" cmd /c "npm run dev"

timeout /t 5 /nobreak >nul

echo Electron 창을 엽니다...
npm run electron

exit
```

**배치 파일 설명:**
1. UTF-8 인코딩 설정 (한글 지원)
2. node_modules 존재 확인
3. 없으면 자동 설치
4. Next.js 개발 서버 백그라운드 실행
5. 5초 대기
6. Electron 창 실행

### 3단계: README 파일 생성

**파일명:** `portable-dist/README.txt`

```
# 더죤환경기술(주) 기술진단팀 협업 플랫폼 - 배포 버전

## 설치 요구사항
- Node.js 18 이상 설치 필요
- 인터넷 연결 필요 (Firebase 연동)

## 실행 방법
1. 실행.bat 파일을 더블클릭
2. 첫 실행 시 자동으로 필요한 패키지 설치
3. Electron 창이 열리면서 로그인 화면 표시

## 기본 관리자 계정
- 이메일: admin@thezone.com
- 비밀번호: admin123!

## 주의사항
- 이 폴더를 이동하거나 파일을 삭제하지 마세요
- node_modules 폴더는 필수 파일입니다
- .env.local 파일에는 Firebase 설정이 포함되어 있습니다

## 문제 해결
1. 실행이 안되면 node_modules 폴더를 삭제하고 다시 실행
2. 포트 3000이 사용 중이라는 오류가 나면 다른 프로그램을 종료
3. Firebase 오류가 나면 인터넷 연결 확인

## 버전
v1.0.0 - 초기 배포 버전
```

### 4단계: ZIP 압축

```powershell
Compress-Archive -Path "portable-dist\*" -DestinationPath "앱이름_v1.0.0.zip" -Force
```

**압축 시간:** 약 2-3분 (node_modules 때문에)  
**최종 파일 크기:** 400-500MB

---

## 🔧 electron/main.js 핵심 코드

개발 서버를 내부에서 자동 실행하도록 수정:

```javascript
const { spawn } = require('child_process');
let nextServer = null;

function startNextServer() {
  return new Promise((resolve, reject) => {
    const nextProcess = spawn('npm', ['run', 'dev'], {
      cwd: path.join(__dirname, '..'),
      shell: true,
      env: { ...process.env, BROWSER: 'none' }
    });

    nextProcess.stdout.on('data', (data) => {
      console.log(`Next.js: ${data}`);
      if (data.toString().includes('Ready') || data.toString().includes('Local:')) {
        setTimeout(() => resolve(), 2000);
      }
    });

    nextServer = nextProcess;
    setTimeout(() => resolve(), 10000); // 10초 타임아웃
  });
}

app.whenReady().then(async () => {
  // 서버가 이미 실행 중인지 확인
  const http = require('http');
  const checkServer = () => {
    return new Promise((resolve) => {
      http.get('http://localhost:3000', (res) => {
        resolve(true);
      }).on('error', () => {
        resolve(false);
      });
    });
  };

  const serverRunning = await checkServer();
  
  if (!serverRunning) {
    await startNextServer();
  }
  
  createWindow();
});
```

---

## 📦 package.json 설정 (참고용)

**중요:** 이 설정은 성공하지 못했지만 참고용으로 남깁니다.

```json
{
  "main": "electron/main.js",
  "build": {
    "appId": "com.company.app",
    "productName": "앱 이름",
    "directories": {
      "output": "dist"
    },
    "files": [
      "electron/**/*",
      "src/**/*",
      "public/**/*",
      "package.json",
      "next.config.js",
      ".env.local",
      "node_modules/**/*"
    ],
    "asarUnpack": [
      "node_modules/**/*"
    ],
    "win": {
      "target": [
        {
          "target": "portable",
          "arch": ["x64"]
        }
      ]
    },
    "asar": true
  }
}
```

**주의:** electron-builder는 다음 오류로 실패했습니다:
- `app-builder.exe process failed ERR_ELECTRON_BUILDER_CANNOT_EXECUTE`
- 경로에 공백이나 한글이 있으면 더욱 실패 가능성 높음

---

## 🚫 실패한 방법들 (참고)

### 1. Next.js 프로덕션 빌드
```bash
npm run build
```
**문제:** "Creating an optimized production build..." 단계에서 무한 대기  
**원인:** 
- 복잡한 컴포넌트 구조
- API 라우트 문제
- 메모리 부족
- 알 수 없는 내부 오류

**시도한 해결책 (모두 실패):**
- ✗ 메모리 증가 (`NODE_OPTIONS=--max-old-space-size=4096`)
- ✗ ESLint 비활성화
- ✗ 캐시 삭제 (`.next`, `node_modules/.cache`)
- ✗ Next.js 버전 다운그레이드 (15 → 14)
- ✗ Google Fonts 제거
- ✗ standalone 모드
- ✗ experimental 기능 비활성화

### 2. electron-builder
```bash
npm run dist
```
**문제:** `app-builder.exe` 실행 오류  
**에러 코드:** `ERR_ELECTRON_BUILDER_CANNOT_EXECUTE` (3221225786)  
**원인:**
- 경로에 한글 ("바탕 화면")
- 경로에 공백
- Windows 보안 정책
- app-builder.exe 호환성 문제

**시도한 해결책 (모두 실패):**
- ✗ NSIS 인스톨러
- ✗ Portable 단일 실행 파일
- ✗ 프로젝트 경로 이동 (C:\Work_Jindan)
- ✗ asar 패키징 on/off

### 3. electron-packager
**시도하지 않음** - electron-builder와 유사한 문제 예상

---

## 💡 다른 프로젝트 적용 시 체크리스트

### .NET WinForms 프로젝트라면
- ✅ Visual Studio로 직접 빌드 (F5)
- ✅ 게시(Publish) 기능 사용
- ✅ ClickOnce 배포
- ✅ 설치 프로젝트(Setup Project) 추가
→ **훨씬 간단하고 안정적!**

### Electron + Next.js 프로젝트라면
1. **먼저 Next.js 빌드 테스트**
   ```bash
   npm run build
   ```
   - 5분 안에 완료되지 않으면 포기
   - 다른 방법 고려

2. **빌드 실패 시 대안:**
   - ✅ 수동 ZIP 패키징 (위의 성공 방법)
   - ✅ Docker 컨테이너
   - ✅ 클라우드 호스팅 + 바로가기만 배포

3. **프로젝트 구조 단순화:**
   - API 라우트 최소화
   - 컴포넌트 복잡도 낮추기
   - 외부 라이브러리 최소화
   - 이미지/폰트 최적화

4. **경로 주의사항:**
   - ❌ 공백 포함 경로
   - ❌ 한글 포함 경로
   - ✅ `C:\Projects\MyApp` 형태 권장

---

## 📞 배포 시 사용자 안내사항

### 필수 요구사항
1. **Node.js 18 이상**
   - 다운로드: https://nodejs.org/
   - LTS 버전 권장

2. **인터넷 연결**
   - Firebase 인증 사용 시 필수

3. **관리자 권한** (선택)
   - 설치 시 필요할 수 있음

### 설치 가이드 (사용자용)
1. ZIP 파일 압축 해제
2. `실행.bat` 더블클릭
3. 첫 실행 시 설치 진행 (2-3분)
4. 이후 실행 시 즉시 실행

### 문제 발생 시
- **포트 충돌:** 작업 관리자에서 Node.js 프로세스 종료
- **설치 오류:** node_modules 폴더 삭제 후 재실행
- **Firebase 오류:** 인터넷 연결 확인

---

## 🎓 교훈 및 권장사항

### Next.js + Electron 조합의 문제점
1. **복잡한 빌드 파이프라인**
   - Next.js 빌드 → Electron 빌드 → 패키징
   - 각 단계마다 실패 가능성

2. **디버깅 어려움**
   - 오류 메시지 불친절
   - 로그 분석 어려움
   - 해결책 찾기 힘듦

3. **의존성 지옥**
   - 수백 개의 npm 패키지
   - 버전 충돌
   - 네이티브 모듈 컴파일

### 차기 프로젝트 권장사항

#### 기업용 Windows 앱이라면:
**1순위: .NET WinForms / WPF**
- Visual Studio 통합 개발
- 간단한 빌드 프로세스
- 안정적인 배포
- 풍부한 컨트롤

**2순위: Electron (단순 구조)**
- HTML + Vanilla JS만 사용
- React/Next.js 같은 프레임워크 배제
- 간단한 UI만

**3순위: PWA (웹 기반)**
- 설치 불필요
- 자동 업데이트
- 크로스 플랫폼

#### Electron을 꼭 써야 한다면:
1. **프레임워크 최소화**
   - React만 (Next.js 제외)
   - 또는 Vanilla JS

2. **빌드 도구 단순화**
   - Vite (Next.js 대신)
   - electron-forge (electron-builder 대신)

3. **개발 초기부터 빌드 테스트**
   - 프로토타입 단계에서 빌드 성공 확인
   - 너무 늦으면 되돌리기 힘듦

---

## 📝 최종 요약

### 이번 프로젝트 성공 방법
```
1. 전체 소스 + node_modules 복사
2. 실행.bat 배치 파일 생성
3. ZIP으로 압축
4. 사용자에게 배포
5. 사용자가 Node.js 설치 + 실행.bat 실행
```

### 시간 소요
- 개발: 정상
- 빌드 시도: 6-8시간 (실패)
- 대안 방법: 30분 (성공)

### 결론
**모던 웹 개발 스택은 기업용 Windows 앱 개발에 부적합할 수 있습니다.**

Visual Basic / .NET WinForms가 그리운 것은 당연합니다. 
실제로 그것이 더 나은 선택일 수 있습니다.

---

**작성자 노트:** 이 문서는 실제 경험을 바탕으로 작성되었습니다. Next.js + Electron 조합의 빌드 실패는 흔한 문제이며, 완벽한 해결책은 없습니다. 차기 프로젝트에서는 더 단순한 스택을 고려하세요.
